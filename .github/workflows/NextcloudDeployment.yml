# This workflow will do a clean install of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

on:
  push:
    branches:
      - master
env: 
  AZURE_DEVOPS_EXT_PAT:  ${{ secrets.AZURE_DEVOPS_PAT }}

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    environment: dev
    steps:
    - uses: actions/checkout@v2
    
    - name: Make Release Folder
      run: mkdir Release
      
    - name: Runner Versions
      run: echo ${{ env.GITHUB_RUN_NUMBER }}
    
    - name: Zip Folder
      run: zip -r ./Release/release.zip .
      
    - name: 'Upload Artifact'
      uses: actions/upload-artifact@v1
      with:
        name: nextcloud-artifact
        path: ${{ github.workspace }}/Release/release.zip
        
    - name: Publish package
      uses: Azure/cli@1.0.4
      with:
        azcliversion: 2.0.72
        inlineScript: |
          pip install --upgrade pip
          pip install --upgrade pip --target /opt/az/lib/python3.6/site-packages/
          az extension add --name azure-devops
          echo ${{ secrets.AZURE_DEVOPS_PAT }} | az devops login --organization https://dev.azure.com/Vimaec
          az artifacts universal publish --organization https://dev.azure.com/Vimaec/ --project="dms-production" --scope project --feed nextcloud-official --name nextcloud --version 0.0.${{ env.GITHUB_RUN_NUMBER }} --description "Description" --path ./Release/
        
